<?xml version="1.0" encoding="UTF-8"?>
<!-- Builds the AnyWikiDraw cookbook for TWiki. -->
<project name="build-twikidraw" default="all" basedir=".">
    <target name="init">
        <property name="version" value="0.13.3"/>
        <property name="src.jhotdraw" value="src/jhotdraw7/java"/>
        <property name="lib" value="lib"/>
        <property name="src.main" value="src/main/java"/>
        <property name="src.twiki4.1" value="src/main/wiki/twiki 4.1"/>
        <property name="src.twiki4.3" value="src/main/wiki/twiki 4.3"/>
        <property name="src.demo" value="src/main/wiki/demo"/>
        <property name="build" value="build/classes"/>
        <property name="dist" value="dist/AnyWikiDraw ${version}/anywikidraw"/>
        <property name="dist.twiki4.1" value="${dist}/twiki 4.1"/>
        <property name="dist.twiki4.3" value="${dist}/twiki 4.3"/>
        <property name="dist.demo" value="dist/AnyWikiDraw ${version}/demo"/>
        <property name="dist.applet4.1" value="${dist.twiki4.1}/pub/TWiki/AnyWikiDrawPlugin"/>
        <property name="dist.applet4.3" value="${dist.twiki4.3}/pub/TWiki/AnyWikiDrawPlugin"/>
        <property name="author" value="Werner Randelshofer, AnyWikiDraw.org"/>
        <property name="keystore.file" value="../../../../_Keystore/JavaKeystore"/>
        <property name="keystore.alias" value="werner"/>
        <property name="keystore.storepass" value="werner"/>
        <property name="debug" value="false"/>
    </target>
    <target name="clean" depends="init">
        <delete dir="${build}" />
        <delete dir="${dist.twiki4.1}" />
        <delete dir="${dist.twiki4.3}" />
        <delete dir="${dist.demo}" />
    </target>
    
    <target name="applet.compile" depends="init,clean">
        <mkdir dir="${build}"/>
        <javac
                destdir="${build}"
                srcdir="${src.main}:${src.jhotdraw}"
                debug="${debug}"
                source="1.5"
                optimize="true"
                encoding="UTF-8"

         >
            <classpath path="${lib}/java_30.zip"/>
            <classpath path="${lib}/swing-layout.jar"/>
            <include name="org/anywikidraw/twiki/TWikiDrawingApplet.java"/> 
            <include name="net/n3/nanoxml/StdXMLParser.java" />
        </javac>
        <copy todir="${build}/org/anywikidraw/any">
            <fileset dir="${src.main}">
                <include name="org/anywikidraw/any/*.properties"/>
                <include name="org/anywikidraw/any/**/*.png"/>
            </fileset>
        </copy>
        <copy todir="${build}">
            <fileset dir="${src.jhotdraw}" >
                <include name="org/jhotdraw/app/action/images/editCut.png"/>
                <include name="org/jhotdraw/app/action/images/editCopy.png"/>
                <include name="org/jhotdraw/app/action/images/editPaste.png"/>
                <include name="org/jhotdraw/app/action/images/spacerIcon.png"/>
                <include name="org/jhotdraw/app/Label*.properties"/>

                <include name="org/jhotdraw/gui/Label*.properties"/>

                <include name="org/jhotdraw/draw/Label*.properties"/>
                <include name="org/jhotdraw/draw/action/images/*.png"/>

                <include name="org/jhotdraw/samples/svg/action/images/*.png"/>
                <include name="org/jhotdraw/samples/svg/Label*.properties"/>

                <include name="org/jhotdraw/undo/images/*.png"/>
                <include name="org/jhotdraw/undo/Label*.properties"/>
            </fileset>
        </copy>
        <echo file="${build}/org/anywikidraw/any/version.txt"
            message="${version}"/>
    </target>
   
    <target name="applet.jar" depends="init,applet.compile">
        <!--delete dir="${dist}" /-->
        <mkdir dir="${dist}"/>
        <copy todir="${dist}">
            <fileset dir=".">
                <include name="*.html"/>
            </fileset>
        </copy>
        <delete dir="${dist.twiki4.1}"/>
        <mkdir dir="${dist.twiki4.1}"/>
        <delete dir="${dist.twiki4.3}"/>
        <mkdir dir="${dist.twiki4.3}"/>
        <mkdir dir="${dist.applet4.1}"/>
        <jar destfile="${dist.applet4.1}/AnyWikiDrawForTWiki.jar" basedir="${build}"
        index="true" compress="true">
            <manifest>
                <attribute name="Built-By" value="${author}"/>
                <attribute name="Main-Class" value="org.anywikidraw.twiki.TWikiDrawingApplet"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>
        <exec executable="pack200">
            <arg value="${dist.applet4.1}/AnyWikiDrawForTWiki.jar.pack.gz"/>
            <arg value="${dist.applet4.1}/AnyWikiDrawForTWiki.jar"/>
        </exec>
        <copy todir="${dist.applet4.3}">
            <fileset dir="${dist.applet4.1}">
                <include name="*.jar" />
                <include name="*.jar.pack.gz" />
            </fileset>
        </copy>
        <copy todir="${dist.twiki4.1}">
            <fileset dir="${src.twiki4.1}">
                <exclude name="**/.*" />
            </fileset>
        </copy>
        <copy todir="${dist.twiki4.3}">
            <fileset dir="${src.twiki4.3}">
                <exclude name="**/.*" />
            </fileset>
        </copy>
    </target>
    <target name="applet.signedjar" depends="applet.jar">
        
        <!-- create a signed version of the .jar file -->
        <exec executable="pack200">
            <arg value="-r"/>
            <arg value="${dist.applet4.1}/AnyWikiDrawForTWiki.jar"/>
        </exec>
        <signjar alias="${keystore.alias}" storepass="${keystore.storepass}"
                keystore="${keystore.file}" 
                jar="${dist.applet4.1}/AnyWikiDrawForTWiki.jar"
                >
        </signjar>        
        
        <!-- create a signed version of the .jar.pack.gz file -->
        <exec executable="pack200">
            <arg value="${dist.applet4.1}/AnyWikiDrawForTWiki.jar.pack.gz"/>
            <arg value="${dist.applet4.1}/AnyWikiDrawForTWiki.jar"/>
        </exec>
        <copy todir="${dist.applet4.3}">
            <fileset dir="${dist.applet4.1}">
                <include name="*.jar" />
                <include name="*.jar.pack.gz" />
            </fileset>
        </copy>
    </target>
    <target name="dist" depends="clean,applet.signedjar">
        
        <!-- create a directory for the demo -->
        <mkdir dir="${dist.demo}"/>
        
        <!-- copy files needed for the demo -->
        <copy todir="${dist.demo}">
            <fileset dir="${src.demo}">
                <exclude name="**/.*"/>
            </fileset>
        </copy>
        <copy todir="${dist.demo}/lib">
            <fileset dir="${dist.applet4.3}">
                <include name="AnyWikiDraw*jar*"/>
            </fileset>
        </copy>
        
        <zip file="${dist}/anywikidraw-${version}-for-twiki-4.1.zip">
            <fileset dir="${dist.twiki4.1}">
                <exclude name="**/.*"/>
            </fileset>
        </zip>
        <zip file="${dist}/anywikidraw-${version}-for-twiki-4.3.zip">
            <fileset dir="${dist.twiki4.3}">
                <exclude name="**/.*"/>
            </fileset>
        </zip>

        <delete dir="${dist.twiki4.1}"/>
        <delete dir="${dist.twiki4.3}"/>
    </target>
    <target name="applet.run-jar" depends="init">
        <java fork="true" jar="${dist.applet4.3}/AnyWikiDrawForTWiki.jar">
        </java>
    </target>
    <target name="applet.run-compiled" depends="init">
        <java fork="true" classpath="${build}" classname="org.anywikidraw.twiki.TWikiDrawingApplet">
        </java>
    </target>
    <target name="applet.appletviewer" depends="init">
        <exec executable="appletviewer">
        <arg value="${build}/twikidraw.html"/>
        </exec>
    </target>
</project>
